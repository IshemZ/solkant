<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostic Google Analytics</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 10px; }
    h2 { color: #666; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .status { padding: 15px; margin: 10px 0; border-radius: 4px; font-weight: 500; }
    .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px 10px 0;
    }
    button:hover { background: #0056b3; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    button.success { background: #28a745; }
    button.success:hover { background: #218838; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border-left: 4px solid #007bff;
    }
    code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; }
    .step { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; }
    .step-number {
      display: inline-block;
      width: 30px;
      height: 30px;
      background: #007bff;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      margin-right: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Diagnostic Google Analytics Dashboard</h1>
    <p>Cet outil va vÃ©rifier pourquoi vos Ã©vÃ©nements n'apparaissent pas dans GA4 DebugView.</p>

    <div id="results"></div>

    <h2>Actions Rapides</h2>
    <button class="success" onclick="activateAnalytics()">âœ… Activer les Analytics</button>
    <button onclick="runDiagnostic()">ğŸ” Lancer le Diagnostic</button>
    <button onclick="testEvent()">ğŸ§ª Envoyer un Ã‰vÃ©nement Test</button>
    <button class="danger" onclick="clearConsent()">ğŸ—‘ï¸ Effacer le Consentement</button>

    <h2>Instructions</h2>
    <div class="step">
      <span class="step-number">1</span>
      <strong>Cliquez sur "Activer les Analytics"</strong> pour donner le consentement
    </div>
    <div class="step">
      <span class="step-number">2</span>
      <strong>Cliquez sur "Lancer le Diagnostic"</strong> pour vÃ©rifier la configuration
    </div>
    <div class="step">
      <span class="step-number">3</span>
      <strong>Cliquez sur "Envoyer un Ã‰vÃ©nement Test"</strong> pour tester l'envoi
    </div>
    <div class="step">
      <span class="step-number">4</span>
      <strong>VÃ©rifiez GA4 DebugView</strong> - Les Ã©vÃ©nements apparaissent en 30-60 secondes
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      document.getElementById('results').appendChild(div);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    function activateAnalytics() {
      clearResults();
      log('ğŸ”§ Activation des analytics...', 'info');

      // 1. Activer le consentement
      const consent = {
        necessary: true,
        analytics: true,
        functional: true
      };
      localStorage.setItem('cookie-consent', JSON.stringify(consent));
      log('âœ… Consentement sauvegardÃ© dans localStorage', 'success');

      // 2. Mettre Ã  jour gtag
      if (window.gtag) {
        window.gtag('consent', 'update', {
          analytics_storage: 'granted'
        });
        log('âœ… Consent mode GA4 mis Ã  jour: analytics_storage = granted', 'success');
      } else {
        log('âš ï¸ gtag n\'est pas encore dÃ©fini. Rechargez la page.', 'warning');
      }

      // 3. Instructions
      log('ğŸ“‹ <strong>Prochaine Ã©tape:</strong> Rechargez la page pour que les changements prennent effet.', 'info');

      setTimeout(() => {
        if (confirm('Voulez-vous recharger la page maintenant ?')) {
          window.location.reload();
        }
      }, 1000);
    }

    function runDiagnostic() {
      clearResults();
      log('ğŸ” <strong>DIAGNOSTIC COMPLET</strong>', 'info');

      // 1. VÃ©rifier le Measurement ID
      const gaIdMeta = document.querySelector('script[src*="googletagmanager.com"]');
      if (gaIdMeta) {
        const match = gaIdMeta.src.match(/id=([^&]+)/);
        if (match) {
          log(`âœ… Measurement ID trouvÃ©: <code>${match[1]}</code>`, 'success');
        }
      } else {
        log('âŒ Script Google Analytics non trouvÃ© dans la page', 'error');
      }

      // 2. VÃ©rifier gtag
      if (typeof window.gtag === 'function') {
        log('âœ… gtag est dÃ©fini et prÃªt', 'success');
      } else {
        log('âŒ gtag n\'est PAS dÃ©fini. Le script GA4 n\'est pas chargÃ©.', 'error');
        log('ğŸ’¡ <strong>Solution:</strong> VÃ©rifiez que NEXT_PUBLIC_GA_MEASUREMENT_ID est dÃ©fini dans .env.local', 'warning');
        return;
      }

      // 3. VÃ©rifier dataLayer
      if (window.dataLayer && Array.isArray(window.dataLayer)) {
        log(`âœ… dataLayer existe avec ${window.dataLayer.length} entrÃ©es`, 'success');

        // Montrer les derniers Ã©vÃ©nements
        const lastEvents = window.dataLayer.slice(-5).map(entry => {
          if (Array.isArray(entry) && entry[0] === 'event') {
            return `Event: ${entry[1]}`;
          }
          return JSON.stringify(entry).substring(0, 100);
        });

        if (lastEvents.length > 0) {
          log(`ğŸ“Š Derniers Ã©vÃ©nements dans dataLayer:<pre>${lastEvents.join('\n')}</pre>`, 'info');
        }
      } else {
        log('âŒ dataLayer n\'existe pas', 'error');
      }

      // 4. VÃ©rifier le consentement
      const consent = localStorage.getItem('cookie-consent');
      if (consent) {
        try {
          const prefs = JSON.parse(consent);
          if (prefs.analytics === true) {
            log('âœ… Consentement analytics: ACCORDÃ‰', 'success');
          } else {
            log('âŒ Consentement analytics: REFUSÃ‰', 'error');
            log('ğŸ’¡ <strong>Solution:</strong> Cliquez sur "Activer les Analytics"', 'warning');
          }
          log(`ğŸ“‹ PrÃ©fÃ©rences complÃ¨tes: <pre>${JSON.stringify(prefs, null, 2)}</pre>`, 'info');
        } catch (e) {
          log('âš ï¸ Erreur de parsing du consentement', 'warning');
        }
      } else {
        log('âŒ Aucun consentement trouvÃ© dans localStorage', 'error');
        log('ğŸ’¡ <strong>Solution:</strong> Cliquez sur "Activer les Analytics"', 'warning');
      }

      // 5. VÃ©rifier le debug mode
      const hasDebugMode = window.location.search.includes('debug_mode=true');
      if (hasDebugMode) {
        log('âœ… Debug mode activÃ© dans l\'URL', 'success');
      } else {
        log('âš ï¸ Debug mode NON activÃ©. Ajoutez ?debug_mode=true Ã  l\'URL', 'warning');
      }

      // 6. VÃ©rifier le rÃ©seau
      log('ğŸ“¡ <strong>VÃ©rification rÃ©seau:</strong> Ouvrez l\'onglet Network (DevTools) et filtrez par "google-analytics.com" ou "collect"', 'info');
      log('Si vous voyez des requÃªtes vers google-analytics.com â†’ Les Ã©vÃ©nements sont envoyÃ©s âœ…', 'info');
      log('Si aucune requÃªte â†’ Le consent mode bloque l\'envoi âŒ', 'info');

      // RÃ©sumÃ©
      log('<hr><strong>ğŸ¯ RÃ‰SUMÃ‰:</strong>', 'info');
      if (typeof window.gtag === 'function' && consent && JSON.parse(consent).analytics === true) {
        log('âœ… Configuration OK ! Les Ã©vÃ©nements devraient Ãªtre envoyÃ©s.', 'success');
        log('ğŸ“Š VÃ©rifiez GA4 Admin â†’ Configure â†’ DebugView (attendre 30-60 secondes)', 'info');
      } else {
        log('âŒ Configuration incomplÃ¨te. Suivez les solutions ci-dessus.', 'error');
      }
    }

    function testEvent() {
      clearResults();

      if (!window.gtag) {
        log('âŒ gtag n\'est pas dÃ©fini. Impossible d\'envoyer l\'Ã©vÃ©nement.', 'error');
        log('ğŸ’¡ Rechargez la page et rÃ©essayez.', 'warning');
        return;
      }

      // VÃ©rifier le consentement
      const consent = localStorage.getItem('cookie-consent');
      if (!consent || !JSON.parse(consent).analytics) {
        log('âš ï¸ Analytics non activÃ©es. Activez-les d\'abord.', 'warning');
        return;
      }

      log('ğŸ§ª Envoi d\'un Ã©vÃ©nement test...', 'info');

      // Envoyer un Ã©vÃ©nement de test
      window.gtag('event', 'test_diagnostic', {
        page_category: 'diagnostic',
        timestamp: new Date().toISOString(),
        debug_mode: true
      });

      log('âœ… Ã‰vÃ©nement test envoyÃ©: <code>test_diagnostic</code>', 'success');
      log('ğŸ“Š VÃ©rifiez dans la console du navigateur pour voir les logs [GA4 Debug]', 'info');
      log('ğŸ“Š VÃ©rifiez dans GA4 DebugView (attendre 30-60 secondes)', 'info');

      // VÃ©rifier dataLayer
      if (window.dataLayer) {
        const lastEntry = window.dataLayer[window.dataLayer.length - 1];
        log(`ğŸ“‹ Dernier Ã©vÃ©nement dans dataLayer: <pre>${JSON.stringify(lastEntry, null, 2)}</pre>`, 'info');
      }
    }

    function clearConsent() {
      if (confirm('Voulez-vous vraiment effacer le consentement et recharger la page ?')) {
        localStorage.removeItem('cookie-consent');
        log('ğŸ—‘ï¸ Consentement effacÃ©', 'success');
        setTimeout(() => window.location.reload(), 500);
      }
    }

    // Auto-diagnostic au chargement
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('ğŸ‘‹ Bienvenue dans le diagnostic Google Analytics', 'info');
        log('ğŸ’¡ Commencez par cliquer sur "Activer les Analytics"', 'warning');
      }, 500);
    });
  </script>
</body>
</html>
